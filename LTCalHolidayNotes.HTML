<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dynamic Lead Time Calculator</title>
<style>
Â  body { font-family: Inter, Arial, sans-serif; background:#f4f7fb; margin:0; padding:22px; color:#0b1a2b }
Â  h1{margin:0 0 12px}
Â  .section { background:#fff; padding:16px; border-radius:10px; margin-bottom:16px; box-shadow:0 6px 18px rgba(2,6,23,0.06)}
Â  .btn { padding:8px 12px; border:none; border-radius:8px; background:#0ea5a4; color:#fff; cursor:pointer }
Â  .ghost{background:transparent;color:#0ea5a4;border:1px solid #c7f0ea}
Â  .smallBtn{padding:6px 8px;background:#e6eef2;border-radius:6px;border:none;cursor:pointer}
Â  table{width:100%;border-collapse:collapse;margin-top:10px}
Â  th,td{border:1px solid #e6eef2;padding:8px;text-align:center;font-size:13px}
Â  th{background:#f0f9ff;color:#0b3954}
Â  .row{display:flex;gap:8px;align-items:center}
Â  input[type=date], input[type=text], input[type=number]{padding:8px;border:1px solid #e6eef2;border-radius:6px}
Â  .footer{ text-align:center;margin-top:20px;font-size:12px;font-style:italic;color:#6e6e6e }
Â  details summary{list-style:none; cursor:pointer}
Â  .flash{animation:flash-bg 0.6s ease-out}
Â  @keyframes flash-bg{0%{background:#fef9c3}100%{background:transparent}}
Â  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2fe;font-size:11px;color:#0369a1;margin-right:4px}
Â  .muted{color:#64748b;font-size:10px} 
Â  .holiday-text{color:#b91c1c; font-weight:normal}
Â  .narrow{width:110px}
Â  .comparison-row {
        border-top: 2px solid #0ea5a4;
        padding-top: 10px;
        margin-bottom: 15px;
    }
    .scenario-label {
        font-weight: bold;
        min-width: 100px;
    }
</style>
</head>
<body>

<h1>Dynamic Lead Time Calculator</h1>

<details class="section" id="settingsPanel" open>
Â  <summary class="btn">Settings (click to open)</summary>
Â  <div style="margin-top:12px">
Â  Â  <h3>Durations (days)</h3>
Â  Â  <div class="row" style="gap:12px;flex-wrap:wrap;">
Â  Â  Â  <label>Order â†’ Fabric ETD <input id="s_d1" type="number" value="60" style="width:90px"></label>
Â  Â  Â  <label>Fabric ETD â†’ Inhouse <input id="s_d2" type="number" value="30" style="width:90px"></label>
Â  Â  Â  <label>Inhouse â†’ Prod End <input id="s_d3" type="number" value="45" style="width:90px"></label>
Â  Â  Â  <label>ETD â†’ ETA <input id="s_d4" type="number" value="60" style="width:90px"></label>
Â  Â  Â  <label>ETA â†’ CDD <input id="s_d5" type="number" value="14" style="width:90px"></label>
Â  Â  </div>

Â  Â  <h3 style="margin-top:12px">Holiday Settings</h3>
Â  Â  <div id="holidayArea"></div>
Â  Â  <div style="margin-top:8px"><button id="addHoliday" class="smallBtn">+ Add Holiday</button></div>

Â  Â  <h3 style="margin-top:12px">Seasons (CDD)</h3>
Â  Â  <div id="seasonArea"></div>
Â  Â  <div style="margin-top:8px"><button id="addSeason" class="smallBtn">+ Add Season</button></div>

Â  Â  <h3 style="margin-top:14px">Display Date Format</h3>
Â  Â  <div style="font-size:13px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
Â  Â  Â  <label><input type="radio" name="fmt" value="bd" checked> 25/01/2026 (dd/mm/yyyy)</label>
Â  Â  Â  <label><input type="radio" name="fmt" value="us"> 01-25-2026 (mm-dd-yyyy)</label>
Â  Â  Â  <label><input type="radio" name="fmt" value="mon"> 25-Jan-2026</label>
Â  Â  Â  <label><input type="radio" name="fmt" value="iso"> 2026-01-25 (ISO)</label>
Â  Â  Â  <span id="currentFmt" class="pill">Current: dd/mm/yyyy</span>
Â  Â  </div>

Â  Â  <div style="margin-top:12px"><button id="saveSettings" class="btn">Save Settings</button></div>

Â  Â  <p style="margin-top:10px;font-size:13px;color:#475569">
Â  Â  Â  Notes: <span class="pill">Order Due: Monâ€“Fri</span>
Â  Â  Â  <span class="pill">Fabric In-house: Sunâ€“Thu</span>
Â  Â  Â  <span class="pill">ETD ex-BD: Sunday vessels</span>
Â  Â  Â  <span class="pill">Eid & CNY holidays extend lead time</span>
Â  Â  </p>
Â  </div>
</details>

<div class="section" id="overviewSection" style="max-width:520px">
Â  <h2 style="font-size:16px;margin:0 0 6px">Holiday Overview (impacting lead time)</h2>
Â  <div id="holidayOverview"></div>
</div>

<div class="section" id="backwardSection">
Â  <h2>Backward Planning (Input: CDD per season)</h2>
Â  <div id="backwardChart" style="margin-top:12px"></div>
Â  <p style="margin-top:6px;font-size:11px;color:#64748b">
Â  Â  Legend: <span class="pill">Monâ€“Fri = Order Due</span>
Â  Â  <span class="pill">Sunâ€“Thu = Fabric In-house</span>
Â  Â  <span class="pill">Sunday = ETD ex-BD</span>
Â  Â  <span class="pill">Red dates = impacted by holidays</span>
Â  </p>
</div>

<div class="section" id="forwardSection">
Â  <h2>Forward Planning (Lead Time Comparison)</h2>
    <div class="comparison-row">
        <div class="row" style="margin-bottom: 10px;">
            <span class="scenario-label">Scenario 1 (Date A):</span>
            <input type="date" id="masterOrderDue1" style="width:150px;">
        </div>
        <div class="row">
            <span class="scenario-label">Scenario 2 (Date B):</span>
            <input type="date" id="masterOrderDue2" style="width:150px;">
        </div>
    </div>
Â  <div id="forwardChart"></div>
Â  <p style="margin-top:6px;font-size:11px;color:#64748b">
Â  Â  Legend: <span class="pill">Order Due: Monâ€“Fri</span>
Â  Â  <span class="pill">Fabric In-house: Sunâ€“Thu</span>
Â  Â  <span class="pill">ETD ex-BD: Sunday vessels</span>
Â  Â  <span class="pill">Red dates = impacted by holidays</span>
Â  </p>
</div>

<footer class="footer">Calculator developed by Musfikur Rahman â€“ Perry Ellis Bangladesh | Copyright Â© 2025.</footer>

<script>
Â  // ðŸ”¸ flash helper for small refresh animation
Â  function flash(element) {
Â  Â  if (!element) return;
Â  Â  element.classList.remove('flash');
Â  Â  void element.offsetWidth; // reflow to restart animation
Â  Â  element.classList.add('flash');
Â  }

(function(){
Â  const el = (id)=>document.getElementById(id);
Â  let dateFormat = 'bd';

Â  function fmt(d, formatOverride){
Â  Â  const currentFormat = formatOverride || dateFormat;
Â  Â  if(!d) return '';
Â  Â  if(typeof d==='string') d=new Date(d+'T00:00:00');
Â  Â  if(!(d instanceof Date) || isNaN(d.getTime())) return '';
Â  Â  const dd = String(d.getDate()).padStart(2,'0');
Â  Â  const mm = String(d.getMonth()+1).padStart(2,'0');
Â  Â  const yyyy = d.getFullYear();
Â  Â  const monNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
Â  Â  switch(currentFormat){
Â  Â  Â  case 'us': return `${mm}-${dd}-${yyyy}`;
Â  Â  Â  case 'mon': return `${dd}-${monNames[d.getMonth()]}-${yyyy}`;
Â  Â  Â  case 'iso': return `${yyyy}-${mm}-${dd}`;
Â  Â  Â  default: return `${dd}/${mm}/${yyyy}`;
Â  Â  }
Â  }

Â  function getISODate(d) {
Â  Â  if (!(d instanceof Date) || isNaN(d.getTime())) return '';
Â  Â  return d.toISOString().slice(0, 10);
Â  }
Â  
Â  function parseDateISO(s){ return s? new Date(s+'T00:00:00'): null }
Â  function addDays(d,n){ const x = new Date(d); x.setDate(x.getDate()+n); return x }
Â  function subDays(d,n){ const x=new Date(d); x.setDate(x.getDate()-n); return x }
Â  function adjustToMonFriPrev(d){ const dt=new Date(d); while(dt.getDay()===0 || dt.getDay()===6) dt.setDate(dt.getDate()-1); return dt }
Â  function adjustToMonFriNext(d){ const dt=new Date(d); while(dt.getDay()===0 || dt.getDay()===6) dt.setDate(dt.getDate()+1); return dt }
Â  function adjustToSunThuNext(d){ const dt=new Date(d); while(dt.getDay()>4) dt.setDate(dt.getDate()+1); return dt }
Â  function adjustToSunThuPrev(d){ const dt=new Date(d); while(dt.getDay()>4) dt.setDate(dt.getDate()-1); return dt }
Â  function adjustToNextSunday(d){ const dt=new Date(d); const daysAhead = (7 - dt.getDay())%7; dt.setDate(dt.getDate()+daysAhead); return dt }

Â  // settings
Â  let settings = {
Â  Â  durations:{d1:60,d2:30,d3:45,d4:60,d5:14},
Â  Â  holidays:[
Â  Â  Â  {name:'1st Eid 2026', from:'2026-03-18', to:'2026-03-29'},
Â  Â  Â  {name:'2nd Eid 2026', from:'2026-05-23', to:'2026-05-31'},
Â  Â  Â  {name:'CNY 2026', from:'2026-02-03', to:'2026-03-03'}
Â  Â  ],
Â  Â  seasons:[
Â  Â  Â  {name:'SPRING 2026', cdd:'2026-01-25'},
Â  Â  Â  {name:'SUMMER 2026', cdd:'2026-04-25'},
Â  Â  Â  {name:'FALL 2026', cdd:'2026-07-25'},
Â  Â  Â  {name:'HOLIDAY 2026', cdd:'2026-10-25'}
Â  Â  ]
Â  };

Â  // Using current context date
Â  const today = new Date('2025-11-17T00:00:00'); 
Â  
Â  // FIX: Fixed rows for comparison
Â  let forwardRows = [ 
Â  Â  {id: 1, name:'Scenario 1', due: getISODate(today)}, 
Â  Â  {id: 2, name:'Scenario 2', due: getISODate(addDays(today, 14))} 
Â  ];

Â  function overlapDays(rangeStart, rangeEnd, hol){
Â  Â  const s = new Date(rangeStart); const e = new Date(rangeEnd);
Â  Â  const hs = new Date(hol.from+'T00:00:00'); const he = new Date(hol.to+'T00:00:00');
Â  Â  const start = s>hs? s : hs; const end = e<he? e: he; if(end < start) return 0; return Math.round((end-start)/(24*3600*1000))+1;
Â  }

Â  // Function to check if a specific holiday impacts a time span
Â  function getImpactedHolidayNames(rangeStart, rangeEnd, holidayRegex) {
Â  Â  return settings.holidays
Â  Â  Â  Â  .filter(h => holidayRegex.test(h.name) && overlapDays(rangeStart, rangeEnd, h) > 0)
Â  Â  Â  Â  .map(h => h.name);
Â  }

Â  // --- Holiday Extension Logic (Recalculated to prevent extreme creep) ---

Â  function extendForChinaHolidays(startDate, durationDays){
Â  Â  let s = new Date(startDate);
Â  Â  let originalEnd = addDays(s, durationDays);
Â  Â  let tempEnd = originalEnd;
Â  Â  
Â  Â  let maxIter = 50; 
Â  Â  while(maxIter-- > 0){
Â  Â  Â  let currentOverlap = 0;
Â  Â  Â  settings.holidays.forEach(h=>{ 
Â  Â  Â  Â  if(/CNY|China|Oct|October/i.test(h.name)){ 
Â  Â  Â  Â  Â  currentOverlap += overlapDays(s, tempEnd, h); 
Â  Â  Â  Â  } 
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  let newRequiredDuration = durationDays + currentOverlap;
      let newEnd = addDays(s, newRequiredDuration);
      
      if (getISODate(newEnd) === getISODate(tempEnd)) {
          tempEnd = newEnd;
          break; 
      }
      if (newEnd < tempEnd && maxIter < 49) {
          break;
      }
      
      tempEnd = newEnd;
Â  Â  }
    
Â  Â  return {end: tempEnd, extraDays: Math.round((tempEnd - originalEnd)/(24*3600*1000))};
Â  }
    
Â  function extendForEid(startDate, durationDays){
Â  Â  let s = new Date(startDate);
Â  Â  let originalEnd = addDays(s, durationDays);
Â  Â  let tempEnd = originalEnd;
Â  Â  
Â  Â  let maxIter = 50; 
Â  Â  while(maxIter-- > 0){
Â  Â  Â  let currentOverlap = 0;
Â  Â  Â  settings.holidays.forEach(h=>{ 
Â  Â  Â  Â  if(/Eid/i.test(h.name)){ 
Â  Â  Â  Â  Â  currentOverlap += overlapDays(s, tempEnd, h); 
Â  Â  Â  Â  } 
Â  Â  Â  });
Â  Â  Â  
Â  Â  Â  let newRequiredDuration = durationDays + currentOverlap;
      let newEnd = addDays(s, newRequiredDuration);
      
      if (getISODate(newEnd) === getISODate(tempEnd)) {
          tempEnd = newEnd;
          break; 
      }
      if (newEnd < tempEnd && maxIter < 49) {
          break;
      }
      
      tempEnd = newEnd;
Â  Â  }
    
Â  Â  return {end: tempEnd, extraDays: Math.round((tempEnd - originalEnd)/(24*3600*1000))};
Â  }


Â  // --- Backward calculation (unchanged) ---
Â  function calcBackwardForCDD(cddISO){
Â  Â  const d1 = settings.durations.d1, d2 = settings.durations.d2, d3 = settings.durations.d3, d4 = settings.durations.d4, d5 = settings.durations.d5;
Â  Â  let cdd = parseDateISO(cddISO);
Â  Â  if(!cdd) return null;
Â  Â  let eta = subDays(cdd, d5);
Â  Â  let etdBase = subDays(eta, d4);

Â  Â  let prodEnd = new Date(etdBase);
Â  Â  let prodStart = subDays(prodEnd, d3);
Â  Â  let maxIterEid = 50; 
Â  Â  while(maxIterEid-- > 0){ 
Â  Â  Â  let overlap = 0;
Â  Â  Â  settings.holidays.forEach(h=>{ if(/Eid/i.test(h.name)){ overlap += overlapDays(prodStart, prodEnd, h); } });
Â  Â  Â  if(overlap===0) break;
Â  Â  Â  prodStart = subDays(prodStart, overlap);
Â  Â  }
Â  Â  let fabInhouse = adjustToSunThuPrev(prodStart);
Â  Â  let fabETD = subDays(fabInhouse, d2);

Â  Â  let ordersDue = subDays(fabETD, d1);
Â  Â  let maxIterChina = 50; 
Â  Â  while(maxIterChina-- > 0){ 
Â  Â  Â  let overlap = 0;
Â  Â  Â  settings.holidays.forEach(h=>{ if(/CNY|China|Oct|October/i.test(h.name)){ overlap += overlapDays(ordersDue, fabETD, h); } });
Â  Â  Â  if(overlap===0) break;
Â  Â  Â  ordersDue = subDays(ordersDue, overlap);
Â  Â  Â  fabETD = subDays(fabETD, overlap);
Â  Â  }
Â  Â  ordersDue = adjustToMonFriPrev(ordersDue);
Â  Â  const etdEx = adjustToNextSunday(etdBase);

Â  Â  return {ordersDue, fabETD, fabInhouse, etdEx, eta, cdd};
Â  }

Â  // --- Forward calculation: Adjusted Mon-Fri check ---
Â  function calcForwardForOrder(ordersISO){
Â  Â  const d1 = settings.durations.d1, d2 = settings.durations.d2, d3 = settings.durations.d3, d4 = settings.durations.d4, d5 = settings.durations.d5;
Â  Â  let orders = parseDateISO(ordersISO);
Â  Â  if(!orders) return null;
Â  Â  
    // FIX 1: Use the original date if it is a weekday (Mon=1 to Fri=5).
    // Only adjust if it's a weekend (Sat=6 or Sun=0).
    let ordersAdj = new Date(orders);
    if (orders.getDay() === 0 || orders.getDay() === 6) { 
        ordersAdj = adjustToMonFriNext(orders);
    }

Â  Â  let start = new Date(ordersAdj);
Â  Â  
Â  Â  // D1: Order Due -> Fabric ETD (China Holiday Impact)
Â  Â  let prodResult1 = extendForChinaHolidays(start, d1);
Â  Â  let fabETD = prodResult1.end;
Â  Â  const chinaExtra = prodResult1.extraDays;

Â  Â  let fabIn = addDays(fabETD, d2);
Â  Â  fabIn = adjustToSunThuNext(fabIn);

Â  Â  // D3: Fabric In-house -> Prod End (Eid Holiday Impact)
Â  Â  let prodEnd = addDays(fabIn, d3);
Â  Â  const eidRes = extendForEid(fabIn, d3);
Â  Â  if(eidRes.extraDays>0) prodEnd = eidRes.end;
Â  Â  const eidExtra = eidRes.extraDays;

Â  Â  let etdEx = adjustToNextSunday(prodEnd);
Â  Â  let eta = addDays(etdEx, d4);
Â  Â  let cdd = addDays(eta, d5);

Â  Â  // Get specific holiday names that caused the delays
Â  Â  const chinaHolidays = getImpactedHolidayNames(ordersAdj, fabETD, /CNY|China|Oct|October/i);
Â  Â  const eidHolidays = getImpactedHolidayNames(fabIn, prodEnd, /Eid/i);
Â  Â  
Â  Â  // Impacted check (aggregates only the holidays that caused extension)
Â  Â  const impacted = Array.from(new Set([...chinaHolidays, ...eidHolidays])).join(', ');
Â  Â  const chinaImpact = chinaExtra>0;
Â  Â  const eidImpact = eidExtra>0;

Â  Â  return {
Â  Â  Â  orders:ordersAdj, fabETD, fabIn, prodEnd, etdEx, eta, cdd, 
Â  Â  Â  impacted, chinaImpact, eidImpact,
Â  Â  Â  chinaHolidays, 
Â  Â  Â  eidHolidays Â  Â 
Â  Â  };
Â  }

Â  // --- UI rendering ---
Â  function renderHolidaySettings(){
Â  Â  const area = el('holidayArea'); area.innerHTML='';
Â  Â  settings.holidays.forEach((h,i)=>{
Â  Â  Â  const row = document.createElement('div'); row.className='row';
Â  Â  Â  const inputName = document.createElement('input'); inputName.type='text'; inputName.value=h.name; inputName.onchange=(e)=>{settings.holidays[i].name=e.target.value; renderHolidayOverview(); renderBackwardTable(); renderForwardTable();};
      // Dates retain ISO format for the HTML input type
Â  Â  Â  const inputFrom = document.createElement('input'); inputFrom.type='date'; inputFrom.value=h.from; inputFrom.onchange=(e)=>{settings.holidays[i].from=e.target.value; renderHolidayOverview(); renderBackwardTable(); renderForwardTable(); };
Â  Â  Â  const inputTo = document.createElement('input'); inputTo.type='date'; inputTo.value=h.to; inputTo.onchange=(e)=>{settings.holidays[i].to=e.target.value; renderHolidayOverview(); renderBackwardTable(); renderForwardTable(); };
Â  Â  Â  const del = document.createElement('button'); del.className='smallBtn'; del.textContent='Delete'; del.onclick=()=>{settings.holidays.splice(i,1); renderHolidaySettings(); renderHolidayOverview(); renderBackwardTable(); renderForwardTable(); };
Â  Â  Â  row.appendChild(inputName); row.appendChild(inputFrom); row.appendChild(inputTo); row.appendChild(del);
Â  Â  Â  area.appendChild(row);
Â  Â  });
Â  }

Â  function renderSeasonSettings(){
Â  Â  const area = el('seasonArea'); area.innerHTML='';
Â  Â  settings.seasons.forEach((s,i)=>{
Â  Â  Â  const row = document.createElement('div'); row.className='row';
Â  Â  Â  const inputName = document.createElement('input'); inputName.type='text'; inputName.value=s.name; inputName.onchange=(e)=>{settings.seasons[i].name=e.target.value; renderBackwardTable();};
      // Dates retain ISO format for the HTML input type
Â  Â  Â  const inputCDD = document.createElement('input'); inputCDD.type='date'; inputCDD.value=s.cdd; inputCDD.onchange=(e)=>{settings.seasons[i].cdd=e.target.value; renderBackwardTable(); };
Â  Â  Â  const del = document.createElement('button'); del.className='smallBtn'; del.textContent='Delete'; del.onclick=()=>{settings.seasons.splice(i,1); renderSeasonSettings(); renderBackwardTable(); };
Â  Â  Â  row.appendChild(inputName); row.appendChild(inputCDD); row.appendChild(del);
Â  Â  Â  area.appendChild(row);
Â  Â  });
Â  }

Â  function renderHolidayOverview(){
Â  Â  const box = el('holidayOverview');
Â  Â  if(!box) return;
Â  Â  if(!settings.holidays.length){ box.innerHTML='<em>No holidays configured</em>'; return; }
Â  Â  let html = '<table><thead><tr><th>Holiday</th><th>From</th><th>To</th></tr></thead><tbody>';
Â  Â  settings.holidays.forEach(h=>{
Â  Â  Â  const f = h.from?parseDateISO(h.from):null;
Â  Â  Â  const t = h.to?parseDateISO(h.to):null;
Â  Â  Â  // Display dates in the currently selected format
Â  Â  Â  html += `<tr><td>${h.name}</td><td>${fmt(f)}</td><td>${fmt(t)}</td></tr>`;
Â  Â  });
Â  Â  html += '</tbody></table>';
Â  Â  box.innerHTML = html;
Â  }

Â  function renderBackwardTable(){
Â  Â  const out = el('backwardChart');
Â  Â  let html = `<table><thead><tr><th class='narrow'>Season</th><th>CDD</th><th>ETA (USA)</th><th>ETD ex-BD</th><th>Fabric In-house</th><th>Fabric ETD</th><th>Order Due</th><th>Holiday impact</th></tr></thead><tbody>`;
Â  Â  settings.seasons.forEach(s=>{
Â  Â  Â  if(!s.cdd) return;
Â  Â  Â  const res = calcBackwardForCDD(s.cdd);
Â  Â  Â  if(!res) return;

Â  Â  Â  const impacted = settings.holidays.filter(h=> overlapDays(res.ordersDue, res.etdEx, h)>0 ).map(h=>h.name).join(', ');

Â  Â  Â  const chinaImpact = settings.holidays.some(h=> /CNY|China|Oct|October/i.test(h.name) && overlapDays(res.ordersDue, res.fabETD, h)>0);
Â  Â  Â  const eidImpact = settings.holidays.some(h=> /Eid/i.test(h.name) && overlapDays(res.fabInhouse, res.etdEx, h)>0);

Â  Â  Â  html += `<tr>
Â  Â  Â  Â  <td>${s.name}</td>
Â  Â  Â  Â  <td class='${chinaImpact||eidImpact?"holiday-text":""}'>${fmt(res.cdd)}</td>
Â  Â  Â  Â  <td>${fmt(res.eta)}</td>
Â  Â  Â  Â  <td class='${eidImpact?"holiday-text":""}'>${fmt(res.etdEx)}</td>
Â  Â  Â  Â  <td class='${eidImpact?"holiday-text":""}'>${fmt(res.fabInhouse)}</td>
Â  Â  Â  Â  <td class='${eidImpact?"holiday-text":""}'>${fmt(res.fabETD)}</td>
Â  Â  Â  Â  <td class='${chinaImpact?"holiday-text":""}'>${fmt(res.ordersDue)}</td>
Â  Â  Â  Â  <td>${impacted}</td>
Â  Â  Â  </tr>`;
Â  Â  });
Â  Â  html += '</tbody></table>';
Â  Â  out.innerHTML = html;
Â  Â  flash(el('backwardSection'));
Â  }

Â  function renderForwardTable(){
Â  Â  const out = el('forwardChart');
Â  Â  
Â  Â  let html = `<table><thead><tr><th class='narrow'>Scenario</th><th>Order Due</th><th>Fabric ETD</th><th>Fabric In-house</th><th>ETD ex-BD</th><th>ETA</th><th>CDD</th><th>Holiday impact</th><th>Action</th></tr></thead><tbody>`;
Â  Â  forwardRows.forEach((r,i)=>{
Â  Â  Â  // Scenarios are fixed and linked to master inputs (no in-cell editing here)
Â  Â  Â  html += `<tr data-i='${r.id}'>
Â  Â  Â  Â  <td>${r.name}</td>
Â  Â  Â  Â  <td class='order-due-display' data-i='${r.id}'>-</td> 
Â  Â  Â  Â  <td class='fabETD'>-</td>
Â  Â  Â  Â  <td class='fabIn'>-</td>
Â  Â  Â  Â  <td class='etdEx'>-</td>
Â  Â  Â  Â  <td class='eta'>-</td>
Â  Â  Â  Â  <td class='cdd'>-</td>
Â  Â  Â  Â  <td class='impact'>-</td> 
Â  Â  Â  Â  <td><button class='smallBtn delRow' data-i='${r.id}'>Delete</button></td>
Â  Â  Â  </tr>`;
Â  Â  });
Â  Â  html += `</tbody></table>`;
Â  Â  out.innerHTML = html;

    // Handle delete listener (only needed if we switch back to dynamic rows, keeping it minimal now)
Â  Â  out.querySelectorAll('.delRow').forEach(b=>{
Â  Â  Â  b.addEventListener('click', (e)=>{
Â  Â  Â  Â  const id = Number(e.target.dataset.i);
Â  Â  Â  Â  const index = forwardRows.findIndex(r => r.id === id);
         if (index !== -1) {
             forwardRows.splice(index, 1);
             renderForwardTable();
         }
Â  Â  Â  });
Â  Â  });
    
    // Initial compute for fixed rows
Â  Â  forwardRows.forEach((r)=> computeFillForwardRow(r.id));
Â  Â  flash(el('forwardSection'));
Â  }

Â  function computeFillForwardRow(id){
Â  Â  const row = document.querySelector(`tr[data-i="${id}"]`);
Â  Â  if(!row) return;
Â  Â  
Â  Â  const r = forwardRows.find(item => item.id === id);
Â  Â  if(!r) return;
Â  Â  
Â  Â  const due = r.due ? parseDateISO(r.due) : null;
Â  Â  const impactCell = row.querySelector('.impact');
    const orderDueDisplay = row.querySelector('.order-due-display');

Â  Â  if(!due || isNaN(due.getTime())){
Â  Â  Â  ['fabETD','fabIn','etdEx','eta','cdd'].forEach(cls=>{
Â  Â  Â  Â  const cell=row.querySelector('.'+cls);
Â  Â  Â  Â  if(cell) cell.textContent='';
Â  Â  Â  });
Â  Â  Â  if (orderDueDisplay) orderDueDisplay.textContent = '---';
Â  Â  Â  if(impactCell) impactCell.textContent = ''; 
Â  Â  Â  return;
Â  Â  }

Â  Â  // Calculate based on the user's selected date (stored in r.due ISO string)
Â  Â  const res = calcForwardForOrder(r.due); 
Â  Â  if(!res) return;

Â  Â  // Reset cell content and color before filling
Â  Â  ['fabETD','fabIn','etdEx','eta','cdd'].forEach(cls=>{
Â  Â  Â  const cell=row.querySelector('.'+cls);
Â  Â  Â  if(cell) cell.innerHTML = '';
Â  Â  Â  if(cell) cell.classList.remove('holiday-text');
Â  Â  });
    
    // --- Order Due Date Display FIX ---
    // Display the final, adjusted start date used for the entire calculation chain.
    if (orderDueDisplay) orderDueDisplay.textContent = fmt(res.orders);

    // --- Filling and adding holiday notes to the correct columns ---

Â  Â  // Fabric ETD (Impacted by China/CNY)
Â  Â  let fabETDCell = row.querySelector('.fabETD');
    fabETDCell.textContent = fmt(res.fabETD);
    if (res.chinaHolidays.length > 0) {
        fabETDCell.innerHTML += `<br><span class="muted">(${res.chinaHolidays.join(', ')})</span>`;
    }

Â  Â  row.querySelector('.fabIn').textContent = fmt(res.fabIn);

Â  Â  // ETD ex-BD (Impacted by Eid/Production)
Â  Â  let etdExCell = row.querySelector('.etdEx');
    etdExCell.textContent = fmt(res.etdEx);
    if (res.eidHolidays.length > 0) {
        etdExCell.innerHTML += `<br><span class="muted">(${res.eidHolidays.join(', ')})</span>`;
    }

Â  Â  row.querySelector('.eta').textContent = fmt(res.eta);
Â  Â  row.querySelector('.cdd').textContent = fmt(res.cdd);

    // Holiday Impact Column uses only the holidays that caused extension
    if (impactCell) {
        impactCell.textContent = res.impacted; 
    }

Â  Â  // --- Applying Red Color Highlighting ---
Â  Â  
Â  Â  if(res.chinaImpact){
Â  Â  Â  row.querySelector('.fabETD').classList.add('holiday-text');
Â  Â  Â  row.querySelector('.fabIn').classList.add('holiday-text');
Â  Â  Â  row.querySelector('.cdd').classList.add('holiday-text');
Â  Â  }
Â  Â  if(res.eidImpact){
Â  Â  Â  row.querySelector('.fabIn').classList.add('holiday-text');
Â  Â  Â  row.querySelector('.etdEx').classList.add('holiday-text');
Â  Â  Â  row.querySelector('.eta').classList.add('holiday-text');
Â  Â  Â  row.querySelector('.cdd').classList.add('holiday-text');
Â  Â  }
Â  }

Â  // Initialization and Button Wiring
Â  function init(){
Â  Â  el('s_d1').value = settings.durations.d1;
Â  Â  el('s_d2').value = settings.durations.d2;
Â  Â  el('s_d3').value = settings.durations.d3;
Â  Â  el('s_d4').value = settings.durations.d4;
Â  Â  el('s_d5').value = settings.durations.d5;
Â  Â  
    // --- Dual Input Setup ---
    const row1 = forwardRows.find(r => r.id === 1);
    const row2 = forwardRows.find(r => r.id === 2);
    
    el('masterOrderDue1').value = row1 ? row1.due : getISODate(today);
    el('masterOrderDue2').value = row2 ? row2.due : getISODate(addDays(today, 14));

    // Handle Master Date Picker Change for Scenario 1
    el('masterOrderDue1').addEventListener('change', (e) => {
        if (row1) {
            row1.due = e.target.value;
            computeFillForwardRow(row1.id);
        }
    });

    // Handle Master Date Picker Change for Scenario 2
    el('masterOrderDue2').addEventListener('change', (e) => {
        if (row2) {
            row2.due = e.target.value;
            computeFillForwardRow(row2.id);
        }
    });

Â  Â  // Button Wiring (Settings)
Â  Â  el('addHoliday').onclick = ()=>{
Â  Â  Â  settings.holidays.push({name:'New Holiday', from:getISODate(addDays(today, 30)), to:getISODate(addDays(today, 37))});
Â  Â  Â  renderHolidaySettings();
Â  Â  Â  renderHolidayOverview();
Â  Â  Â  renderBackwardTable();
Â  Â  Â  renderForwardTable();
Â  Â  };
Â  Â  el('addSeason').onclick = ()=>{
Â  Â  Â  settings.seasons.push({name:'NEW SEASON', cdd:getISODate(addDays(today, 200))});
Â  Â  Â  renderSeasonSettings();
Â  Â  Â  renderBackwardTable();
Â  Â  Â  renderForwardTable();
Â  Â  };
Â  Â  el('saveSettings').onclick = ()=>{
Â  Â  Â  settings.durations.d1 = Number(el('s_d1').value);
Â  Â  Â  settings.durations.d2 = Number(el('s_d2').value);
Â  Â  Â  settings.durations.d3 = Number(el('s_d3').value);
Â  Â  Â  settings.durations.d4 = Number(el('s_d4').value);
Â  Â  Â  settings.durations.d5 = Number(el('s_d5').value);
Â  Â  Â  renderBackwardTable();
Â  Â  Â  renderForwardTable();
Â  Â  Â  flash(el('settingsPanel'));
Â  Â  };
Â  Â  // Date format change logic triggers full re-render for consistency
Â  Â  document.querySelectorAll('input[name="fmt"]').forEach(r=>{
Â  Â  Â  r.addEventListener('change', (e)=>{
Â  Â  Â  Â  dateFormat = e.target.value;
Â  Â  Â  Â  const labelMap = {bd:'dd/mm/yyyy', us:'mm-dd-yyyy', mon:'dd-MMM-yyyy', iso:'yyyy-mm-dd'};
Â  Â  Â  Â  el('currentFmt').textContent = 'Current: ' + labelMap[dateFormat];
Â  Â  Â  Â  
Â  Â  Â  Â  renderHolidayOverview();
Â  Â  Â  Â  renderBackwardTable();
Â  Â  Â  Â  renderForwardTable();
Â  Â  Â  });
Â  Â  });
Â  Â  
Â  Â  // Initial Render
Â  Â  renderHolidaySettings();
Â  Â  renderSeasonSettings();
Â  Â  renderHolidayOverview();
Â  Â  renderBackwardTable();
Â  Â  renderForwardTable();
Â  }

Â  init();
})();
</script>
</body>
</html>